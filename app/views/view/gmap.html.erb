<script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
<script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>


<h1>This is Gmap page</h1>

<div style='width: 800px;'>
  <div id="map" style='width: 800px; height: 400px;'></div>
</div>

<script type = 'text/javascript'>

  eventsData = <%=raw @hash_eventsData.to_json %>;

  console.log(eventsData);

  var map;
  var bounds = new google.maps.LatLngBounds();

  function initMap() {
    // Create a map object and specify the DOM element for display.
    map = new google.maps.Map(document.getElementById('map'), {
      // center: {lat: -37.7850713, lng: 145.12622},
      scrollwheel: false//,
      // zoom: 15
    });
  }

  function makeIntPoint(intPointData){
    var marker = new google.maps.Marker({
      position: intPointData 
    });

    var form = "<form action='/view/change_event_transportation/" + intPointData["event_id"] + "' method='post'>"
            + '<select name="transportation">'
            + '<option value="walking">walking</option>'
            + '<option value="car">car</option>'
            + '<option value="tram">tram</option>'
            + '</select>'
            + "<button type = 'submit'> Change the transportation </button>"
            + "</form>";

    var infowindow = new google.maps.InfoWindow({      
      content: "Transportation: " + intPointData["transportation"] + "<br/><br/>" + form
    });

    marker.addListener('click', function(e) {

      infowindow.open(map,marker);
    });

    marker.setMap(map);
  }

  function makeTransferZone(transferZoneData){    

    var image = 'http://vignette3.wikia.nocookie.net/farmville/images/9/9b/Purple_Flag-icon.png/revision/latest/scale-to-width-down/50?cb=20100110191552';

    var marker = new google.maps.Marker({
        position: transferZoneData,
        draggable:true,
        icon: image
      });

    var infowindow = new google.maps.InfoWindow({      
      content: "TransferZone:"
    });

    marker.addListener('click', function(e) {
      infowindow.open(map,marker);
    });

    marker.setMap(map);

    bounds.extend(marker.getPosition());
    console.log(marker.getPosition());
  }

  function drawTripIntermediatePoints(eventsData) {
    for(var i=0;i<eventsData.length;i++){
      for(var j=1;j<eventsData[i]["intermediatepoints"].length-1;j++){
        makeIntPoint(eventsData[i]["intermediatepoints"][j]);        
      }
    }
  }

  function drawTripPolyline(eventsData) {
    for(var i=0;i<eventsData.length;i++){
      var intPointsData = [];
      for(var j=0;j<eventsData[i]["intermediatepoints"].length;j++){
        intPointsData.push(eventsData[i]["intermediatepoints"][j]);
      }
      random_color = '#'+Math.floor(Math.random()*16777215).toString(16);
      drawEventPolyline(intPointsData, random_color);
    }
  }

  function drawEventPolyline(intPointsData, color){
    console.log(intPointsData);

    var polylinePath;

    var polylineCoordinates = [];
    for(var i=0;i<intPointsData.length;i++){
      polylineCoordinates.push(intPointsData[i]);
    }

    polylinePath = new google.maps.Polyline({
      path: polylineCoordinates,
      geodesic: true,
      strokeColor: color,
      strokeOpacity: 1.0,
      strokeWeight: 5
    });

    var form = "<form action='/view/change_event_transportation/" + intPointsData[0]["event_id"] + "' method='post'>"
            + '<select name="transportation">'
            + '<option value="walking">walking</option>'
            + '<option value="car">car</option>'
            + '<option value="tram">tram</option>'
            + '</select>'
            + "<button type = 'submit'> Change the transportation </button>"
            + "</form>";

    var infowindow = new google.maps.InfoWindow({      
      content: "Transportation: " + intPointsData[0]["transportation"] + "<br/><br/>" + form
    });

    polylinePath.addListener('click', function(e) {  
      infowindow.open(map);
      infowindow.setPosition(e.latLng);
    });

    polylinePath.setMap(map);
  }

  function drawTripTransferZone(eventsData){
    for(var i=0;i<eventsData.length;i++){
      drawEventTransferZone(eventsData[i],0);
    }
    drawEventTransferZone(eventsData[eventsData.length-1],1);
  }

  function drawEventTransferZone(eventData, index){
      pointsData = eventData["transferzones"];
      makeTransferZone(pointsData[index]);
  }

  initMap();
  drawTripIntermediatePoints(eventsData);
  drawTripPolyline(eventsData);
  drawTripTransferZone(eventsData);
  map.fitBounds(bounds);

</script>